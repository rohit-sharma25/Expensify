<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EXPENSIFY - Smart Expense Tracking</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/animations.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content animate-fade-in-down">
        <div class="brand">
          <div class="brand-logo">
            <img src="img/logo.jpg">
          </div>
          <div class="brand-text">
            <h1>EXPENSIFY</h1>
            <p>Track all of expenses and transactions</p>
          </div>
        </div>

        <div class="user-section" id="auth-section">
          <div id="logged-out-view" class="row">
            <button id="login-btn" class="btn btn-primary">Sign in with Google</button>
            <button id="skip-btn" class="btn btn-secondary">Use Offline</button>
          </div>

          <div id="user-info" class="user-section hidden">
            <div class="user-info">
              <span id="user-name" class="user-name"></span>
              <span id="user-email" class="user-email"></span>
            </div>
            <img id="user-photo" class="user-photo" src="" alt="Profile" />
            <button id="logout-btn" class="btn btn-ghost">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Greeting Section -->
    <section class="greeting-section animate-fade-in-up">
      <div class="greeting-content">
        <div class="greeting-header">
          <div class="greeting-text">
            <h2>Hi, <span id="greeting-name">Ananya</span> üëã</h2>
            <p>Track all of expenses and transactions</p>
          </div>
          <div class="greeting-time" id="current-time">
            <span>üïê</span>
            <span id="time-display"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- AI Smart Dashboard -->
    <div id="ai-smart-dashboard" class="animate-fade-in-up" style="margin-bottom: 24px; display: none;">
      <div class="minimal-insight-card">
        <span class="insight-icon">‚ú®</span>
        <div id="ai-dashboard-insight" class="insight-text">
          <span class="typing-dots">Analyzing spending...</span>
        </div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid animate-fade-in-up stagger-1">
      <!-- Account Balance Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üí≥</div>
          <span class="stat-card-badge" style="background: rgba(91, 108, 242, 0.15); color: #5B6CF2;">BALANCE</span>
        </div>
        <div class="stat-card-body">
          <h3>Account Balance</h3>
          <div class="stat-card-value" id="account-balance">‚Çπ0.00</div>
          <div class="stat-card-trend trend-up" id="balance-trend">
            <span>‚Üë</span>
            <span>+12% from last month</span>
          </div>
        </div>
      </div>

      <!-- Monthly Expenses Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üìä</div>
          <span class="stat-card-badge" style="background: rgba(239, 68, 68, 0.15); color: #EF4444;">EXPENSES</span>
        </div>
        <div class="stat-card-body">
          <h3>Monthly Expenses</h3>
          <div class="stat-card-value"
            style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
            id="monthly-expenses">‚Çπ0.00</div>
          <div class="stat-card-trend" id="expense-trend">
            <span>üìâ</span>
            <span>5% less than last month</span>
          </div>
        </div>
      </div>

      <!-- Total Investment Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üìà</div>
          <span class="stat-card-badge" style="background: rgba(124, 58, 237, 0.15); color: #7C3AED;">INVESTMENT</span>
        </div>
        <div class="stat-card-body">
          <h3>Total Investment</h3>
          <div class="stat-card-value"
            style="background: linear-gradient(135deg, #7C3AED 0%, #A855F7 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
            id="total-investment">‚Çπ0.00</div>
          <div class="stat-card-trend trend-up" id="investment-trend">
            <span>‚Üë</span>
            <span>+8% growth</span>
          </div>
        </div>
      </div>

      <!-- Monthly Income Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üí∞</div>
          <span class="stat-card-badge" style="background: rgba(16, 185, 129, 0.15); color: #10B981;">INCOME</span>
        </div>
        <div class="stat-card-body">
          <h3>Monthly Income</h3>
          <div class="stat-card-value"
            style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
            id="monthly-income">‚Çπ0.00</div>
          <div class="stat-card-trend trend-up">
            <span>üöÄ</span>
            <span>Total earnings this month</span>
          </div>
        </div>
      </div>

      <!-- Goal Card with Edit Functionality -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üéØ</div>
          <span class="stat-card-badge" style="background: rgba(16, 185, 129, 0.15); color: #10B981;">GOAL</span>
        </div>
        <div class="stat-card-body">
          <!-- Goal Display -->
          <div id="goal-display">
            <h3 id="goal-name-display">No Goal Set</h3>
            <div class="stat-card-value"
              style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
              id="goal-amount-display">‚Çπ0.00</div>
            <div class="stat-card-trend" id="goal-progress-display">
              <div
                style="width: 100%; background: rgba(0,0,0,0.1); height: 6px; border-radius: 99px; margin-top: 8px; overflow: hidden;">
                <div id="goal-progress-bar"
                  style="width: 0%; height: 100%; background: linear-gradient(90deg, #10B981 0%, #059669 100%); border-radius: 99px;">
                </div>
              </div>
              <span id="goal-progress-text" style="margin-top: 4px; font-size: 0.8rem;">0% Complete</span>
            </div>
            <button id="edit-goal-btn" class="btn btn-secondary"
              style="margin-top: 12px; width: 100%; font-size: 0.85rem;">
              ‚úèÔ∏è Edit Goal
            </button>
          </div>

          <!-- Goal Edit Form (Hidden by default) -->
          <div id="goal-edit-form" class="hidden">
            <div style="margin-bottom: 12px;">
              <label
                style="display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 6px; font-weight: 600;">GOAL
                NAME</label>
              <input type="text" id="goal-name-input" placeholder="e.g., iPhone 17 Pro"
                style="width: 100%; padding: 8px 12px; font-size: 0.9rem;" />
            </div>
            <div style="margin-bottom: 12px;">
              <label
                style="display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 6px; font-weight: 600;">TARGET
                AMOUNT (‚Çπ)</label>
              <input type="number" id="goal-amount-input" placeholder="0.00" step="0.01"
                style="width: 100%; padding: 8px 12px; font-size: 0.9rem;" />
            </div>
            <div style="margin-bottom: 12px;">
              <label
                style="display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 6px; font-weight: 600;">CURRENT
                SAVINGS (‚Çπ)</label>
              <input type="number" id="goal-saved-input" placeholder="0.00" step="0.01"
                style="width: 100%; padding: 8px 12px; font-size: 0.9rem;" />
            </div>
            <div class="row" style="gap: 8px;">
              <button id="save-goal-btn" class="btn btn-primary" style="flex: 1; font-size: 0.85rem;">
                üíæ Save Goal
              </button>
              <button id="cancel-goal-btn" class="btn btn-ghost" style="font-size: 0.85rem;">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section animate-fade-in-up stagger-2">
      <!-- Monthly Expenses Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üìä Monthly Statistics</h3>
          <div class="chart-filter">
            <button class="filter-btn active" data-period="6m">6 Month</button>
            <button class="filter-btn" data-period="1y">1 Year</button>
          </div>
        </div>
        <div style="display: flex; gap: 20px; align-items: stretch; min-height: 300px;">
          <div class="chart-filter" id="monthly-chart-type-filter"
            style="display: flex; flex-direction: column; background: rgba(0,0,0,0.05); border-radius:12px; padding: 6px; gap: 8px;">
            <button class="filter-btn active" data-type="expense"
              style="padding: 12px; font-size: 0.8rem; writing-mode: vertical-lr; transform: rotate(180deg); flex: 1;">Expenses</button>
            <button class="filter-btn" data-type="income"
              style="padding: 12px; font-size: 0.8rem; writing-mode: vertical-lr; transform: rotate(180deg); flex: 1;">Income</button>
          </div>
          <div class="chart-container" style="flex: 1; height: 300px;">
            <canvas id="monthly-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Top Category Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üéØ Top Category</h3>
          <div class="chart-filter">
            <button class="filter-btn active" data-view="recent">Recent</button>
          </div>
        </div>
        <div class="chart-container" style="height: 250px;">
          <canvas id="category-chart"></canvas>
        </div>
        <div class="category-list" id="category-list">
          <!-- Categories will be dynamically inserted -->
        </div>
      </div>
    </div>

    <!-- Recent Expenses Section -->
    <section class="expenses-section animate-fade-in-up stagger-3">
      <div class="section-header">
        <h3 class="section-title" id="recent-transactions-title">üìã Recent Expenses</h3>
        <div class="row">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="recent">Recent</button>
          <a href="expense.html" class="btn btn-primary">+ Add Entry</a>
        </div>
      </div>

      <table class="expenses-table">
        <thead>
          <tr>
            <th>S.N</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Sub Category</th>
            <th>Date</th>
            <th>Mode</th>
            <th>Description</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="recent-expenses-body">
          <!-- Expenses will be dynamically inserted -->
        </tbody>
      </table>
    </section>

    <!-- Bill & Subscription Section -->
    <section class="expenses-section animate-fade-in-up stagger-4">
      <div class="section-header">
        <h3 class="section-title">üí≥ Bill & Subscription</h3>
        <button class="btn btn-secondary">View All</button>
      </div>

      <div class="dashboard-grid" id="subscriptions-grid">
        <!-- Subscriptions will be dynamically inserted -->
      </div>
    </section>
  </main>

  <!-- THE NEW RADIANT AI CHAT UI -->
  <div id="ai-chat-fab" class="ai-fab">
    <span>ü§ñ</span>
  </div>

  <div id="ai-chat-popup" class="ai-chat-popup hidden">
    <div class="ai-chat-header">
      <div class="ai-chat-title">
        <span>ü§ñ</span>
        <span>Finance AI</span>
      </div>
      <button id="ai-chat-close" class="btn-icon"
        style="background:none; border:none; color:white; cursor:pointer; font-size:1.5rem;">√ó</button>
    </div>
    <div id="ai-chat-body" class="ai-chat-body">
      <div class="msg-ai">Hello! I'm your new financial advisor. How can I help you today?</div>
    </div>
    <div class="ai-chat-footer">
      <input type="text" id="ai-chat-input" class="ai-chat-input" placeholder="Type your question..."
        autocomplete="off">
      <button id="ai-chat-send" class="ai-chat-send">üöÄ</button>
    </div>
  </div>

  <script type="module">
    import { AuthService } from './js/auth-service.js';
    import { DBService } from './js/db-service.js';
    import { AIService } from './js/ai-service.js';
    import { calculateBudgetTrajectory, analyzeSpendingByCategory } from './js/analytics.js';
    import { createTrajectoryChart, destroyChart } from './js/chart-utils.js';

    // DOM Elements
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const skipBtn = document.getElementById('skip-btn');
    const loggedOutView = document.getElementById('logged-out-view');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const userPhoto = document.getElementById('user-photo');
    const greetingName = document.getElementById('greeting-name');

    // AI Chat elements
    // AI Chat elements (New IDs)
    const fab = document.getElementById('ai-chat-fab');
    const popup = document.getElementById('ai-chat-popup');
    const closeBtn = document.getElementById('ai-chat-close');
    const chatInput = document.getElementById('ai-chat-input');
    const chatSend = document.getElementById('ai-chat-send');
    const chatBody = document.getElementById('ai-chat-body');

    let contextData = { finances: [], budget: null };
    let monthlyChart = null;
    let categoryChart = null;
    let lastAiUpdate = 0;
    let currentUser = null;
    let currentChartType = 'expense';
    let currentFilter = 'all';

    // Update time
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-IN', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      const dateStr = now.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
      document.getElementById('time-display').textContent = `${timeStr} | ${dateStr}`;
    }
    updateTime();
    setInterval(updateTime, 60000);

    // Auth handling
    AuthService.onUserChange(async (user) => {
      currentUser = user;
      if (user) {
        userInfo.classList.remove('hidden');
        loggedOutView.classList.add('hidden');
        userName.textContent = user.displayName;
        userEmail.textContent = user.email;
        userPhoto.src = user.photoURL;
        greetingName.textContent = user.displayName.split(' ')[0];
        loadData(user.uid);
      } else {
        const isLocal = AuthService.isLocalOnly();
        if (isLocal) {
          userInfo.classList.remove('hidden');
          loggedOutView.classList.add('hidden');
          userName.textContent = "Guest User";
          userEmail.textContent = "Local Mode";
          userPhoto.src = "https://ui-avatars.com/api/?name=Guest&background=5B6CF2&color=fff";
          greetingName.textContent = "Guest";
          loadData(null);
        } else {
          loggedOutView.classList.remove('hidden');
          userInfo.classList.add('hidden');
        }
      }
    });

    async function loadData(uid) {
      // Set up real-time subscriptions for automatic updates
      DBService.subscribe(uid, 'finances', (data) => {
        contextData.finances = data;
        renderDashboard(contextData.finances, contextData.budget);
        renderCharts(contextData.finances);
        renderRecentExpenses(contextData.finances, currentFilter, currentChartType);
        renderSubscriptions(contextData.finances);
        updateAISmartDashboard();
      });

      DBService.subscribe(uid, 'monthlyBudget', (data) => {
        const settings = data.find(d => d.id === 'settings');
        contextData.budget = settings ? settings.value : null;
        renderDashboard(contextData.finances, contextData.budget);
        updateAISmartDashboard();
      });

      DBService.subscribe(uid, 'goals', (data) => {
        const savedGoal = data.find(g => g.id === 'userGoal');
        updateGoalDisplay(savedGoal || null);
      });

      // Chart Period Listeners
      document.querySelectorAll('[data-period]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const period = btn.dataset.period;
          renderMonthlyChart(contextData.finances, period === '1y' ? 12 : 6, currentChartType);
        };
      });

      // Chart Type Listeners
      document.querySelectorAll('#monthly-chart-type-filter [data-type]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#monthly-chart-type-filter [data-type]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentChartType = btn.dataset.type;
          const activePeriod = document.querySelector('[data-period].active')?.dataset.period || '6m';
          renderMonthlyChart(contextData.finances, activePeriod === '1y' ? 12 : 6, currentChartType);
          renderCategoryChart(contextData.finances, currentChartType);
          renderRecentExpenses(contextData.finances, currentFilter, currentChartType);

          // Update Titles
          const recentTitle = document.getElementById('recent-transactions-title');
          if (recentTitle) {
            recentTitle.textContent = currentChartType === 'expense' ? 'üìã Recent Expenses' : 'üí∞ Recent Income';
          }
        };
      });

      // Filter Recent Expenses Listeners
      document.querySelectorAll('.expenses-section .filter-btn[data-filter]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.expenses-section .filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderRecentExpenses(contextData.finances, currentFilter, currentChartType);
        };
      });
    }

    // Goal Management Functions
    function updateGoalDisplay(goal) {
      if (!goal || !goal.name || !goal.targetAmount) {
        document.getElementById('goal-name-display').textContent = 'No Goal Set';
        document.getElementById('goal-amount-display').textContent = '‚Çπ0.00';
        document.getElementById('goal-progress-bar').style.width = '0%';
        document.getElementById('goal-progress-text').textContent = '0% Complete';
        return;
      }

      const savedAmount = goal.savedAmount || 0;
      const targetAmount = goal.targetAmount || 0;
      const progress = targetAmount > 0 ? Math.min((savedAmount / targetAmount) * 100, 100) : 0;

      document.getElementById('goal-name-display').textContent = goal.name;
      document.getElementById('goal-amount-display').textContent = `‚Çπ${targetAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('goal-progress-bar').style.width = `${progress}%`;
      document.getElementById('goal-progress-text').textContent = `${progress.toFixed(0)}% Complete (‚Çπ${savedAmount.toLocaleString('en-IN')} saved)`;
    }

    // Goal Edit/Save Handlers
    document.getElementById('edit-goal-btn').addEventListener('click', async () => {
      const goalData = await DBService.fetchData(AuthService.isLocalOnly() ? null : currentUser?.uid, 'goals');
      const savedGoal = goalData.find(g => g.id === 'userGoal');

      if (savedGoal) {
        document.getElementById('goal-name-input').value = savedGoal.name || '';
        document.getElementById('goal-amount-input').value = savedGoal.targetAmount || '';
        document.getElementById('goal-saved-input').value = savedGoal.savedAmount || '';
      }

      document.getElementById('goal-display').classList.add('hidden');
      document.getElementById('goal-edit-form').classList.remove('hidden');
    });

    document.getElementById('cancel-goal-btn').addEventListener('click', () => {
      document.getElementById('goal-edit-form').classList.add('hidden');
      document.getElementById('goal-display').classList.remove('hidden');
    });

    document.getElementById('save-goal-btn').addEventListener('click', async () => {
      const name = document.getElementById('goal-name-input').value.trim();
      const targetAmount = parseFloat(document.getElementById('goal-amount-input').value) || 0;
      const savedAmount = parseFloat(document.getElementById('goal-saved-input').value) || 0;

      if (!name || targetAmount <= 0) {
        alert('Please enter a valid goal name and target amount');
        return;
      }

      const goalData = {
        id: 'userGoal',
        name,
        targetAmount,
        savedAmount
      };

      const uid = AuthService.isLocalOnly() ? null : currentUser?.uid;
      await DBService.saveData(uid, 'goals', 'userGoal', goalData);

      updateGoalDisplay(goalData);
      document.getElementById('goal-edit-form').classList.add('hidden');
      document.getElementById('goal-display').classList.remove('hidden');
    });

    function renderDashboard(finances, budget) {
      const today = new Date();
      const currentMonth = today.toISOString().slice(0, 7);

      // Calculate monthly expenses
      const monthExpenses = finances
        .filter(f => f.type === 'expense' && f.dateISO.startsWith(currentMonth))
        .reduce((sum, f) => sum + f.amount, 0);

      // Calculate monthly income
      const monthIncome = finances
        .filter(f => f.type === 'income' && f.dateISO.startsWith(currentMonth))
        .reduce((sum, f) => sum + f.amount, 0);

      // Calculate total investment
      const totalInvestment = finances
        .filter(f => f.category === 'Investment')
        .reduce((sum, f) => sum + f.amount, 0);

      // Update dashboard
      document.getElementById('account-balance').textContent = `‚Çπ${(monthIncome - monthExpenses).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('monthly-expenses').textContent = `‚Çπ${monthExpenses.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      const monthlyIncomeEl = document.getElementById('monthly-income');
      if (monthlyIncomeEl) {
        monthlyIncomeEl.textContent = `‚Çπ${monthIncome.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      document.getElementById('total-investment').textContent = `‚Çπ${totalInvestment.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function renderCharts(finances) {
      const activePeriod = document.querySelector('[data-period].active')?.dataset.period || '6m';
      renderMonthlyChart(finances, activePeriod === '1y' ? 12 : 6, currentChartType);
      renderCategoryChart(finances, currentChartType);
    }

    async function updateAISmartDashboard() {
      const dashboard = document.getElementById('ai-smart-dashboard');
      const insightEl = document.getElementById('ai-dashboard-insight');
      if (!dashboard || !insightEl) return;

      if (!contextData.budget || contextData.finances.length === 0) {
        dashboard.style.display = 'none';
        return;
      }

      dashboard.style.display = 'block';

      // Throttle AI updates (max once every 30 seconds)
      const now = Date.now();
      if (now - lastAiUpdate < 30000) return;
      lastAiUpdate = now;

      const currentMonth = new Date().toISOString().slice(0, 7);
      const spent = contextData.finances.filter(f => f.type === 'expense' && f.dateISO.startsWith(currentMonth)).reduce((s, f) => s + f.amount, 0);
      const trajectory = calculateBudgetTrajectory(contextData.finances, contextData.budget);
      const categories = analyzeSpendingByCategory(contextData.finances);
      const topCategory = Object.keys(categories).length > 0 ? Object.entries(categories).sort((a, b) => b[1] - a[1])[0][0] : 'N/A';

      // Update card status class
      const card = dashboard.querySelector('.minimal-insight-card');
      if (card) {
        card.classList.remove('status-ok', 'status-alert');
        card.classList.add(trajectory.isOverBudget ? 'status-alert' : 'status-ok');
      }

      try {
        const insight = await AIService.generateDashboardInsight({
          budget: contextData.budget,
          spent: spent,
          trajectory: trajectory,
          topCategory: topCategory
        });

        if (insight) {
          insightEl.innerHTML = insight;
        }
      } catch (err) {
        console.error("Dashboard AI Insight Error:", err);
      }
    }

    function renderMonthlyChart(finances, numMonths = 6, type = 'expense') {
      const ctx = document.getElementById('monthly-chart');
      if (!ctx) return;

      // Get period data
      const months = [];
      const data = [];
      for (let i = numMonths - 1; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthStr = d.toISOString().slice(0, 7);
        const monthName = d.toLocaleDateString('en-IN', { month: 'short' });
        months.push(monthName);

        const monthTotal = finances
          .filter(f => f.type === type && f.dateISO.startsWith(monthStr))
          .reduce((sum, f) => sum + f.amount, 0);
        data.push(monthTotal);
      }

      const chartLabel = type === 'expense' ? 'Expenses' : 'Income';
      const chartColor = type === 'expense' ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)';
      const chartBorder = type === 'expense' ? '#EF4444' : '#10B981';

      if (monthlyChart) monthlyChart.destroy();

      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: chartLabel,
            data: data,
            backgroundColor: chartColor,
            borderColor: chartBorder,
            borderWidth: 2,
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(17, 18, 26, 0.95)',
              padding: 12,
              titleColor: '#F9FAFB',
              bodyColor: '#E5E7EB',
              borderColor: 'rgba(91, 108, 242, 0.3)',
              borderWidth: 1,
              callbacks: {
                label: (context) => `‚Çπ${context.parsed.y.toLocaleString('en-IN')}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: '#9CA3AF' }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#9CA3AF' }
            }
          }
        }
      });
    }

    function renderCategoryChart(finances, type = 'expense') {
      const ctx = document.getElementById('category-chart');
      if (!ctx) return;

      // Calculate category totals
      const categories = {};
      const categoryColors = {
        'Food & Grocery': '#10B981',
        'Investment': '#8B5CF6',
        'Shopping': '#F59E0B',
        'Traveling': '#06B6D4',
        'Miscellaneous': '#6B7280',
        'Bill & Subscription': '#EF4444',
        'Peoples': '#3B82F6',
        'LLM Models': '#8B5CF6'
      };

      finances
        .filter(f => f.type === type)
        .forEach(f => {
          const cat = f.category || (type === 'income' ? 'Salary/Income' : 'Miscellaneous');
          categories[cat] = (categories[cat] || 0) + f.amount;
        });

      const labels = Object.keys(categories);
      const data = Object.values(categories);

      // Dynamic color generation for unknown categories
      const colors = labels.map(l => categoryColors[l] || `hsl(${Math.random() * 360}, 70%, 50%)`);

      if (categoryChart) categoryChart.destroy();

      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(17, 18, 26, 0.95)',
              padding: 12,
              titleColor: '#F9FAFB',
              bodyColor: '#E5E7EB',
              borderColor: 'rgba(91, 108, 242, 0.3)',
              borderWidth: 1,
              callbacks: {
                label: (context) => `${context.label}: ‚Çπ${context.parsed.toLocaleString('en-IN')}`
              }
            }
          },
          cutout: '70%'
        }
      });

      // Render category list
      const categoryList = document.getElementById('category-list');
      categoryList.innerHTML = labels.map((label, i) => `
        <div class="category-item">
          <div class="category-color" style="background: ${colors[i]}"></div>
          <div class="category-info">
            <span class="category-name">${label}</span>
            <span class="category-amount">‚Çπ${data[i].toLocaleString('en-IN')}</span>
          </div>
        </div>
      `).join('');
    }

    function renderRecentExpenses(finances, filter = 'all', type = 'expense') {
      const tbody = document.getElementById('recent-expenses-body');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!finances || finances.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--muted);">No ${type} entries yet</td></tr>`;
        return;
      }

      let filteredExpenses = finances
        .filter(f => f.type === type);

      if (filteredExpenses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--muted);">No ${type} entries yet</td></tr>`;
        return;
      }

      if (filter === 'recent') {
        filteredExpenses = filteredExpenses
          .sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO))
          .slice(0, 5);
      } else {
        filteredExpenses = filteredExpenses
          .sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
      }

      const categoryEmoji = {
        'Food & Grocery': 'üçî',
        'Investment': 'üìà',
        'Shopping': 'üõçÔ∏è',
        'Traveling': '‚úàÔ∏è',
        'Miscellaneous': 'üì¶',
        'Bill & Subscription': 'üí≥',
        'Peoples': 'üë•',
        'LLM Models': 'ü§ñ'
      };

      const amountColor = type === 'expense' ? 'var(--danger)' : 'var(--success)';
      const deleteBg = type === 'expense' ? 'rgba(239,68,68,0.05)' : 'rgba(16,185,129,0.05)';
      const deleteColor = type === 'expense' ? '#EF4444' : '#10B981';
      const deleteBorder = type === 'expense' ? 'rgba(239,68,68,0.15)' : 'rgba(16,185,129,0.15)';

      filteredExpenses.forEach((expense, index) => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid var(--border)';

        const emoji = categoryEmoji[expense.category] || (type === 'income' ? 'üí∞' : 'üí∏');

        tr.innerHTML = `
          <td style="padding:12px; color:var(--muted); font-size:0.85rem;">${index + 1}</td>
          <td style="padding:12px;">
            <span style="font-weight:700; color:${amountColor}; font-size:0.95rem;">${type === 'income' ? '+' : '-'} ‚Çπ${Number(expense.amount).toFixed(2)}</span>
          </td>
          <td style="padding:12px; color:var(--text); font-size:0.85rem;">${emoji} ${expense.category || (type === 'income' ? 'Income' : 'N/A')}</td>
          <td style="padding:12px; color:var(--muted); font-size:0.85rem;">${expense.subCategory || '-'}</td>
          <td style="padding:12px; color:var(--muted); font-size:0.85rem;">${expense.dateISO}</td>
          <td style="padding:12px;">
            <span style="padding: 4px 10px; background: rgba(0,0,0,0.05); border-radius: 99px; font-size: 0.75rem; font-weight:600; color:var(--primary);">
              ${expense.mode || (type === 'income' ? 'Direct' : 'Cash')}
            </span>
          </td>
          <td style="padding:12px; color:var(--text); font-size:0.85rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${expense.desc}
          </td>
          <td style="padding:12px;">
            <button class="btn-delete" data-id="${expense.id}" style="background:${deleteBg}; color:${deleteColor}; border:1px solid ${deleteBorder}; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:700; transition: all 0.2s;">
              Delete
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // Add event listeners to delete buttons
      tbody.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function () {
          const id = this.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this expense?')) {
            const uid = AuthService.isLocalOnly() ? null : currentUser?.uid;
            await DBService.deleteData(uid, 'finances', id);
          }
        });

        // Hover effect
        btn.addEventListener('mouseenter', function () {
          this.style.background = '#EF4444';
          this.style.color = '#FFFFFF';
        });
        btn.addEventListener('mouseleave', function () {
          this.style.background = 'rgba(239,68,68,0.1)';
          this.style.color = '#EF4444';
        });
      });
    }

    function renderSubscriptions(finances) {
      const grid = document.getElementById('subscriptions-grid');
      const subscriptions = finances
        .filter(f => f.category === 'Bill & Subscription')
        .slice(0, 4);

      const icons = {
        'Netflix': 'üé¨',
        'Spotify': 'üéµ',
        'WiFi': 'üì°',
        'Electricity': '‚ö°',
        'LLMs': 'ü§ñ'
      };

      grid.innerHTML = subscriptions.map(sub => `
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-icon">${icons[sub.subCategory] || 'üí≥'}</div>
            <span class="stat-card-badge" style="background: rgba(239, 68, 68, 0.15); color: #EF4444;">ACTIVE</span>
          </div>
          <div class="stat-card-body">
            <h3>${sub.subCategory || sub.desc}</h3>
            <div class="stat-card-value" style="font-size: 1.5rem;">‚Çπ${sub.amount.toLocaleString('en-IN')}</div>
            <div class="stat-card-trend">
              <span style="font-size: 0.8rem; color: var(--muted);">${new Date(sub.dateISO).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // NEW AI CHAT INITIALIZATION
    AIService.init({
      fab: document.getElementById('ai-chat-fab'),
      popup: document.getElementById('ai-chat-popup'),
      close: document.getElementById('ai-chat-close'),
      input: document.getElementById('ai-chat-input'),
      send: document.getElementById('ai-chat-send'),
      body: document.getElementById('ai-chat-body')
    }, () => contextData);

    loginBtn.addEventListener('click', () => AuthService.login());
    skipBtn.addEventListener('click', () => { AuthService.setLocalOnly(true); location.reload(); });
    logoutBtn.addEventListener('click', () => { AuthService.setLocalOnly(false); AuthService.logout(); location.reload(); });
  </script>
</body>

</html>